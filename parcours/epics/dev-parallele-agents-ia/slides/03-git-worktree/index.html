<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Git Worktree - D√©veloppement parall√®le avec agents IA</title>
  <link rel="stylesheet" href="../../../../../lib/theme.css">
  <link rel="stylesheet" href="../../../../_shared/slide-base.css">
  <script type="module">
    import { initTheme } from '../../../../../lib/theme.js';
    initTheme();
  </script>
  <style>
    .architecture-diagram {
      background: var(--color-bg-secondary);
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      margin: var(--space-lg) 0;
      overflow-x: auto;
    }
    .architecture-diagram pre {
      margin: 0;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: var(--font-size-sm);
      line-height: 1.4;
      color: var(--color-text-primary);
    }
    .advantages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-md);
      margin: var(--space-lg) 0;
    }
    .advantage-card {
      background: var(--color-bg-secondary);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      text-align: center;
    }
    .advantage-card .icon {
      font-size: 2rem;
      margin-bottom: var(--space-sm);
    }
    .advantage-card .value {
      font-size: var(--font-size-xl);
      font-weight: bold;
      color: var(--color-accent);
    }
    .code-section {
      margin: var(--space-lg) 0;
    }
    .code-section h3 {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-sm);
    }
    .code-block {
      background: var(--color-bg-code);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .code-block-header {
      background: var(--color-bg-secondary);
      padding: var(--space-sm) var(--space-md);
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      border-bottom: 1px solid var(--color-border);
    }
    .code-block pre {
      margin: 0;
      padding: var(--space-md);
      overflow-x: auto;
      font-size: var(--font-size-sm);
    }
    .code-block code {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }
    .docker-section {
      background: var(--color-bg-secondary);
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      margin-top: var(--space-xl);
      border-left: 4px solid var(--color-info);
    }
    .docker-section h3 {
      margin-top: 0;
    }
    .port-convention {
      background: var(--color-bg-primary);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      font-family: monospace;
      text-align: center;
      margin-top: var(--space-md);
    }
    .comment { color: var(--color-text-muted); }
    .command { color: var(--color-accent); }
    .string { color: var(--color-success); }
  </style>
</head>
<body>
  <article class="slide">
    <h1>üîÄ La solution : Git Worktree</h1>

    <h2>Le principe</h2>

    <p>
      <dfn>Git Worktree</dfn> (disponible depuis Git 2.5) cr√©e plusieurs r√©pertoires de travail qui partagent la m√™me base de donn√©es Git.
      Chaque worktree a ses propres fichiers, son propre index, son propre HEAD ‚Äî mais les commits sont partag√©s instantan√©ment.
    </p>

    <div class="architecture-diagram">
      <pre>my-project/
‚îú‚îÄ‚îÄ .bare/                    <span class="comment"># Base de donn√©es Git partag√©e</span>
‚îú‚îÄ‚îÄ main/                     <span class="comment"># Worktree principal (vous)</span>
‚îú‚îÄ‚îÄ agent-1-auth/             <span class="comment"># Worktree agent 1</span>
‚îú‚îÄ‚îÄ agent-2-api/              <span class="comment"># Worktree agent 2</span>
‚îî‚îÄ‚îÄ agent-3-tests/            <span class="comment"># Worktree agent 3</span></pre>
    </div>

    <div class="advantages-grid">
      <div class="advantage-card">
        <div class="icon">üíæ</div>
        <div class="value">~85%</div>
        <div>√©conomie disque vs clones</div>
      </div>
      <div class="advantage-card">
        <div class="icon">‚ö°</div>
        <div class="value">Instantan√©</div>
        <div>commits partag√©s</div>
      </div>
      <div class="advantage-card">
        <div class="icon">üîí</div>
        <div class="value">0</div>
        <div>conflits de lock Git</div>
      </div>
      <div class="advantage-card">
        <div class="icon">üåø</div>
        <div class="value">N branches</div>
        <div>simultan√©ment</div>
      </div>
    </div>

    <h2>Mise en place</h2>

    <div class="code-section">
      <h3>üì¶ Option 1 : Setup avec bare repository <small>(recommand√©)</small></h3>
      <div class="code-block">
        <div class="code-block-header">bash</div>
        <pre><code><span class="comment"># Cr√©er la structure</span>
mkdir my-project && cd my-project
git clone --bare git@github.com:user/project.git .bare

<span class="comment"># Pointer .git vers le bare repo</span>
echo "gitdir: ./.bare" > .git

<span class="comment"># Configurer le fetch</span>
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
git fetch origin

<span class="comment"># Cr√©er le worktree principal</span>
git worktree add main origin/main</code></pre>
      </div>
    </div>

    <div class="code-section">
      <h3>‚ö° Option 2 : Depuis un repo existant <small>(pour tester)</small></h3>
      <div class="code-block">
        <div class="code-block-header">bash</div>
        <pre><code>cd mon-projet-existant

<span class="comment"># Cr√©er des worktrees pour les agents</span>
git worktree add ../agent-1 -b feature/auth main
git worktree add ../agent-2 -b feature/api main
git worktree add ../agent-3 -b fix/tests main</code></pre>
      </div>
    </div>

    <h2>Commandes essentielles</h2>

    <div class="code-block">
      <div class="code-block-header">bash</div>
      <pre><code><span class="comment"># Cr√©er un worktree avec nouvelle branche</span>
git worktree add &lt;chemin&gt; -b &lt;nouvelle-branche&gt; &lt;base&gt;

<span class="comment"># Lister les worktrees</span>
git worktree list

<span class="comment"># Supprimer un worktree</span>
git worktree remove &lt;chemin&gt;

<span class="comment"># Nettoyer les r√©f√©rences orphelines</span>
git worktree prune</code></pre>
    </div>

    <div class="docker-section">
      <h3>üê≥ Et les services (DB, Redis, etc.) ?</h3>
      <p>
        Les worktrees isolent le code, pas les services. Si vos agents lancent des tests qui utilisent
        une base de donn√©es, vous aurez des collisions.
      </p>
      <p><strong>Solution : Docker Compose par worktree</strong> avec des ports diff√©rents.</p>

      <div class="code-block">
        <div class="code-block-header">docker-compose.yml</div>
        <pre><code>services:
  db:
    image: postgres:16
    ports:
      - "${DB_PORT:-5432}:5432"
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"</code></pre>
      </div>

      <div class="code-block" style="margin-top: var(--space-md);">
        <div class="code-block-header">.env par worktree</div>
        <pre><code><span class="comment"># agent-1/.env</span>
DB_PORT=5410
REDIS_PORT=6310

<span class="comment"># agent-2/.env</span>
DB_PORT=5420
REDIS_PORT=6320</code></pre>
      </div>

      <div class="port-convention">
        Convention : <code>PORT = BASE + (AGENT_INDEX √ó 10)</code>
      </div>
    </div>
  </article>
</body>
</html>
